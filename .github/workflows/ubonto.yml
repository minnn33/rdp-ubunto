name: Ubuntu VNC with noVNC & Auto Cloudflare

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: โ ุชุซุจูุช ุณุทุญ ุงูููุชุจ ู VNC
        run: |
          sudo apt update
          sudo apt install xfce4 xfce4-goodies tightvncserver git wget python3 -y

          # ุฅุนุฏุงุฏ ูููุฉ ุงูุณุฑ ูู VNC
          mkdir -p ~/.vnc
          echo "12345678" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

          # ุฅุนุฏุงุฏ ููู ุจุฏุก xfce
          vncserver :1
          vncserver -kill :1
          echo "#!/bin/bash
          xrdb \$HOME/.Xresources
          startxfce4 &" > ~/.vnc/xstartup
          chmod +x ~/.vnc/xstartup

          # ุชุดุบูู VNC ุนูู ุงูุดุงุดุฉ :1
          vncserver :1 -geometry 1280x720 -depth 24
          sleep 3

      - name: ๐ง ุชุซุจูุช ูุชุดุบูู noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git ~/noVNC
          git clone https://github.com/novnc/websockify ~/noVNC/utils/websockify
          nohup ~/noVNC/utils/websockify/run 6080 localhost:5901 > novnc.log 2>&1 &
          sleep 3

      - name: ๐ ุชุดุบูู Cloudflare Tunnel (TryCloudflare)
        run: |
          wget -O cloudflared https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://localhost:6080 --no-autoupdate > cloudflare.log 2>&1 &
          sleep 8

          # ุงุณุชุฎุฑุงุฌ ุงูุฑุงุจุท
          TUNNEL_URL=$(grep -o 'https://[0-9a-zA-Z.-]*\.trycloudflare.com' cloudflare.log | head -n 1)

          if [ -z "$TUNNEL_URL" ]; then
            echo "โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฑุงุจุท Cloudflare"
            exit 1
          fi

          echo "โ ุฑุงุจุท TryCloudflare ุงูุฃุณุงุณู:"
          echo "$TUNNEL_URL"

          echo "๐ ุฑุงุจุท noVNC ุงููุจุงุดุฑ:"
          echo "$TUNNEL_URL/vnc.html"

          echo "๐งฉ ุฑุงุจุท ุงูุฏุฎูู ุงูุชููุงุฆู (ุจู localhost:5901):"
          echo "$TUNNEL_URL/vnc.html?host=localhost&port=5901"

      - name: ๐ข ุฅุจูุงุก ุงูุฌูุณุฉ ููุชูุญุฉ
        run: |
          echo "๐ ุงูุฌูุณุฉ ุดุบุงูุฉ... ูุง ุชุบูู ุงููุงูุฐุฉ. ุงุถุบุท Cancel ูุฅููุงููุง ูุฏูููุง."
          tail -f /dev/null
